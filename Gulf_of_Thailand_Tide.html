<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gulf of Thailand — Tide (API-only)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet (mini-map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Chart.js + Luxon adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

<style>
:root{--bg:#f6f7fb;--panel:#fff;--txt:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
*{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1100px;margin:18px auto;padding:0 16px}
.hbar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.hbar .sp{margin-left:auto;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:1050px){.grid{grid-template-columns:380px 1fr}}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.card>.hd{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:600}
.card>.bd{padding:14px}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
select,.btn{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);font-size:14px}
.btn{background:var(--accent);border:none;color:#fff;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:14px}
.kv div:nth-child(odd){color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
canvas{background:#eef2ff;border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:14px}
th{color:var(--muted);font-weight:600;text-align:left}
.segment{display:flex;gap:6px}
.segment .seg{background:#fff;border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer}
.segment .seg.active{background:#1f2937;color:#fff;border-color:#1f2937}
#map{height:240px;border-radius:10px;border:1px solid var(--border)}
.footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
.pill{display:inline-block;background:#eef2ff;color:#4338ca;border-radius:999px;padding:2px 8px;font-size:12px}
#msg{color:var(--muted);min-height:18px}
</style>
</head>

<body>
<div class="wrap">
  <div class="hbar">
    <div style="font-weight:700">Gulf of Thailand — Tide (API)</div>
    <div class="sp">Developed by <b>Rattawit W.</b></div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="hd">Stations & Controls</div>
      <div class="bd">
        <label for="station">Choose a station (WGS84)</label>
        <select id="station"></select>

        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px">
          <button id="run" class="btn">Compute</button>
          <div class="segment" id="viewSeg" title="Change viewing window (no extra API calls)">
            <div class="seg active" data-days="1">1 day</div>
            <div class="seg" data-days="3">3 days</div>
            <div class="seg" data-days="7">7 days</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="csv" class="btn">Export CSV</button>
          <button id="png" class="btn">Export PNG</button>
        </div>
        <div id="msg" style="margin-top:8px"></div>

        <div class="hd" style="margin:12px -14px 6px -14px;padding:10px 14px;border-top:1px solid var(--border);border-bottom:none">Result meta data</div>
        <div class="kv bd" id="metaKV">
          <div>Lat, Lon</div><div id="kv-ll">—</div>
          <div>Window</div><div id="kv-win">—</div>
          <div>Interval</div><div id="kv-int">—</div>
          <div>z0</div><div id="kv-z0">—</div>
          <div>Policy</div><div id="kv-policy">Calculates only <b>15 days before today</b> and <b>next 30 days</b> (API-enforced).</div>
        </div>

        <div class="hd" style="margin:12px -14px 6px -14px;padding:10px 14px;border-top:1px solid var(--border);border-bottom:none">Mini map</div>
        <div class="bd"><div id="map"></div></div>

        <div class="footer">Need help? Contact: <a href="mailto:rattawit.aum@gmail.com">rattawit.aum@gmail.com</a></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="hd">Tide curve</div>
      <div class="bd"><canvas id="chart" height="220"></canvas></div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="hd">Daily highs / lows (HH:mm, m)</div>
      <div class="bd" id="hl"></div>
    </div>
  </div>
</div>

<script>
const API = 'https://got-tide.rattawit-aum.workers.dev/api/tides';
const USE_TZ = 'Asia/Bangkok';

// Hard-coded stations
const STATIONS = {
  "AWP26":{"lat":8.5107,"lon":102.2262},
  "AWP36":{"lat":7.94077,"lon":102.6856},
  "B832":{"lat":10.520936,"lon":101.27638},
  "G365":{"lat":7.586336,"lon":102.121412},
  "SBWA":{"lat":8.68628,"lon":101.3838},
  "SGWH":{"lat":8.683,"lon":101.743},
  "PDWA":{"lat":9.47695,"lon":101.394183},
  "PLLQ":{"lat":9.691283333,"lon":101.4042333},
  "BQP":{"lat":8.019097,"lon":102.32179},
  "QPS":{"lat":7.492083333,"lon":102.6147667},
  "FULQ":{"lat":8.933933333,"lon":101.5894333},
  "ERLQ":{"lat":9.077383333,"lon":101.3095},
  "AQP":{"lat":8.260766667,"lon":102.52465},
  "YAWD":{"lat":9.92305,"lon":101.4586},
  "SALQ":{"lat":9.286267,"lon":101.412167}
};

(function initStations(){
  const sel = document.getElementById('station');
  const items = Object.entries(STATIONS)
    .map(([code, v]) => ({ code, lat:+v.lat, lon:+v.lon }))
    .sort((a,b)=> a.code.localeCompare(b.code));
  sel.innerHTML = items.map(({code,lat,lon}) =>
    `<option value="${code}" data-lat="${lat}" data-lon="${lon}">
      ${code} (${lat.toFixed(4)}, ${lon.toFixed(4)})
     </option>`).join('');
})();

// Utils
const dt = luxon.DateTime;
// was: function fmtDDMMYY(ms){ ... 'ddLLyy' }
function fmtYYMMDD(ms){
  return luxon.DateTime.fromMillis(ms).setZone(USE_TZ).toFormat('yyLLdd');
}
function fmtDate(ms){ return dt.fromMillis(ms).setZone(USE_TZ).toFormat('yyyy-LL-dd'); }
function fmtTime(ms){ return dt.fromMillis(ms).setZone(USE_TZ).toFormat('HH:mm'); }
function todayMidnightMs(){ return dt.now().setZone(USE_TZ).startOf('day').toMillis(); }

// API
async function fetchTides(lat, lon){
  const u = new URL(API);
  u.searchParams.set('lat', lat);
  u.searchParams.set('lon', lon);

  // IMPORTANT: always use CORS mode when calling the Worker
  const r = await fetch(u, { mode:'cors' });

  if (!r.ok) {
    let bodyText = '';
    try { bodyText = await r.text(); } catch {}
    throw new Error(`API ${r.status} – ${bodyText || 'no details'}`);
  }
  return r.json();
}


// Chart daily separator
const daySeparator = {
  id:'daySeparator',
  afterDatasetsDraw(chart){
    const {ctx, chartArea, scales} = chart; if(!chartArea||!scales?.x) return;
    const {top,bottom,left,right} = chartArea, x=scales.x, min=x.min, max=x.max;
    if(!Number.isFinite(min)||!Number.isFinite(max)) return;
    let edge = dt.fromMillis(min).setZone(USE_TZ).startOf('day');
    if(edge.toMillis()>min) edge=edge.minus({days:1});
    const edges=[]; for(let t=edge; t.toMillis()<=max+86400000; t=t.plus({days:1})) edges.push(t.toMillis());
    const mids=edges.filter(ms=>ms>min&&ms<max);
    ctx.save(); ctx.beginPath(); ctx.rect(left,top,right-left,bottom-top); ctx.clip();
    ctx.setLineDash([5,5]); ctx.lineWidth=1.25; ctx.strokeStyle='rgba(148,163,184,0.45)';
    for(const ms of mids){ const px=x.getPixelForValue(ms); ctx.beginPath(); ctx.moveTo(px,top); ctx.lineTo(px,bottom); ctx.stroke(); }
    ctx.setLineDash([]); ctx.restore();
  }
};

let chart=null;
function renderChart(series){
  const ctx=document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[{ label:'Tide (m)', data: series.map(([t,y])=>({x:new Date(t), y})), borderWidth:2, pointRadius:0 }] },
    options:{
      responsive:true, animation:false,
      interaction:{ mode:'index', intersect:false, axis:'x' },
      scales:{ x:{ type:'time', adapters:{date:{zone:USE_TZ}} }, y:{ title:{display:true,text:'m'} } }
    },
    plugins:[daySeparator]
  });
}

// High/low
function groupByDay(pts){
  const m=new Map(); const key = ms => dt.fromMillis(ms).setZone(USE_TZ).toFormat('yyyy-LL-dd');
  for(const [t,y] of pts){ const k=key(t); if(!m.has(k)) m.set(k,[]); m.get(k).push([t,y]); }
  return m;
}
function renderHL(highs, lows){
  const div=document.getElementById('hl');
  const hiBy=groupByDay(highs), loBy=groupByDay(lows);
  const days=[...new Set([...hiBy.keys(),...loBy.keys()])].sort();
  const out=[];
  for(const d of days){
    const merged=[...(hiBy.get(d)||[]).map(v=>({t:v[0],y:v[1],type:'High'})),
                  ...(loBy.get(d)||[]).map(v=>({t:v[0],y:v[1],type:'Low'}))].sort((a,b)=>a.t-b.t);
    out.push(`<div style="margin:6px 0 4px;color:#6d28d9;font-weight:600">${d}</div>`);
    out.push('<table><thead><tr><th>Type</th><th style="text-align:center">Time</th><th style="text-align:right">m</th></tr></thead><tbody>');
    for(const {t,y,type} of merged){
      const color = type==='High' ? '#0ea5e9' : '#db2777';
      out.push(`<tr><td style="color:${color}">${type}</td><td style="text-align:center">${fmtTime(t)}</td><td style="text-align:right">${(+y).toFixed(2)}</td></tr>`);
    }
    out.push('</tbody></table>');
  }
  div.innerHTML = out.join('') || '<div class="small">No extrema in range.</div>';
}

// Meta & z0 (2 decimals)
function renderMeta(meta, z0){
  document.getElementById('kv-ll').textContent = `${(+meta.lat).toFixed(4)}, ${(+meta.lon).toFixed(4)}`;
  const s = dt.fromISO(meta.start_iso).setZone(USE_TZ).toFormat('yyyy-LL-dd');
  const e = dt.fromISO(meta.end_iso).setZone(USE_TZ).toFormat('yyyy-LL-dd');
  document.getElementById('kv-win').innerHTML = `${s} → ${e} <span class="pill">API-enforced</span>`;
  document.getElementById('kv-int').textContent = `${meta.interval_min} min`;
  document.getElementById('kv-z0').textContent = `${Number(z0).toFixed(2)} m`;
}

function msg(t){ document.getElementById('msg').textContent = t || ''; }

// Client-side 1/3/7-day view (no extra API)
let full=null; let viewDays=1;
function setActiveSeg(days){
  document.querySelectorAll('#viewSeg .seg').forEach(el=>{
    el.classList.toggle('active', +el.dataset.days === days);
  });
}
function updateView(){
  if(!full) return;
  const start0 = todayMidnightMs();
  const startMs = Math.max(start0, full.series[0][0]);
  const endMs = Math.min(start0 + viewDays*86400000 - 1, full.series[full.series.length-1][0]);
  const inRange = ([t]) => t >= startMs && t <= endMs;
  renderChart(full.series.filter(inRange));
  renderHL((full.highs||[]).filter(inRange), (full.lows||[]).filter(inRange));
}

// Exports (CSV full range from Worker; PNG current view)
function wireExports(stationCode){
  const meta = full.meta || {};
  const startMs = Date.parse(meta.start_iso);
  const endMs   = Date.parse(meta.end_iso);
  const baseNameFull = `${stationCode}_Tide_${fmtYYMMDD(startMs)}_${fmtYYMMDD(endMs)}`;

  document.getElementById('csv').onclick = ()=>{
    if(!full) return alert('Compute first.');
    const rows=[['timestamp_ms','date_local','time_local','tide_m']];
    for(const [t,y] of full.series){
      const d = dt.fromMillis(t).setZone(USE_TZ);
      rows.push([t, d.toFormat('yyyy-LL-dd'), d.toFormat('HH:mm'), Number(y).toFixed(2)]);
    }
    const csv = '\uFEFF'+rows.map(r=>r.join(',')).join('\r\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = baseNameFull+'.csv'; document.body.appendChild(a); a.click(); a.remove();
  };

  document.getElementById('png').onclick = ()=>{
    if(!chart) return alert('Compute first.');
    const a=document.createElement('a'); a.href=document.getElementById('chart').toDataURL('image/png');
    a.download = `${stationCode}_Tide_${fmtYYMMDD(todayMidnightMs())}_${fmtYYMMDD(todayMidnightMs()+viewDays*86400000-1)}.png`;
    document.body.appendChild(a); a.click(); a.remove();
  };
}

// Mini map (no click-to-select; shows all stations; highlights selected)
let map, markers={};
function initMap(){
  map = L.map('map', { zoomControl:true, dragging:true }).setView([9.5,101.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:12, attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  const normalStyle = { radius:6, color:'#0ea5e9', fillColor:'#38bdf8', fillOpacity:0.9, weight:2 };
  const selectedStyle = { radius:7, color:'#ef4444', fillColor:'#f87171', fillOpacity:0.95, weight:2.2 };

  for(const [code, v] of Object.entries(STATIONS)){
    const m = L.circleMarker([v.lat, v.lon], normalStyle).addTo(map);
    m.bindTooltip(`${code}`, {permanent:true, direction:'right', offset:[6,0], className:'station-label'});
    markers[code] = { marker:m, normal:normalStyle, selected:selectedStyle };
  }
  // CSS tweak for label
  const style = document.createElement('style');
  style.textContent = `.station-label{background:transparent;border:none;box-shadow:none;color:#111827;font:12px/1 Inter,system-ui}`;
  document.head.appendChild(style);
}
function highlightStation(code){
  for(const [c, obj] of Object.entries(markers)){
    obj.marker.setStyle(c===code ? obj.selected : obj.normal);
    if (c===code) { obj.marker.bringToFront(); map.setView(obj.marker.getLatLng(), Math.max(7, map.getZoom())); }
  }
}

// Orchestration
async function runSelected(){
  const sel=document.getElementById('station');
  const opt=sel.selectedOptions?.[0]; if(!opt){ return; }
  const code = opt.value;
  const lat=+opt.dataset.lat, lon=+opt.dataset.lon;
  try{
    msg('Computing…');
    const res = await fetchTides(lat, lon);
    if(!Array.isArray(res.series) || res.series.length===0){ msg('No data returned by API.'); return; }
    full = { series:res.series, highs:res.highs||[], lows:res.lows||[], meta:res.meta||{}, z0:res.z0 };
    renderMeta(full.meta, full.z0);
    msg('');

    viewDays = 1; setActiveSeg(viewDays); updateView();
    wireExports(code);
    highlightStation(code);
 } catch(e){
  msg(String(e.message || e));
  console.error(e);
}

}

document.getElementById('run').addEventListener('click', runSelected);
window.addEventListener('DOMContentLoaded', ()=>{
  initMap();
  document.getElementById('station').selectedIndex = 0;
  document.querySelectorAll('#viewSeg .seg').forEach(btn=>{
    btn.addEventListener('click', ()=>{ viewDays = +btn.dataset.days; setActiveSeg(viewDays); updateView(); });
  });
  runSelected(); // auto compute first
});
</script>
</body>
</html>
