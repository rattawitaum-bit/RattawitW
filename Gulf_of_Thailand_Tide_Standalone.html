<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gulf of Thailand — Tide Map (API)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Chart + time adapter (Luxon) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

<!-- Optional presets (safe to keep) -->
<script src="station_coords.js"></script>

<style>
:root { --bg:#f5f7fa; --panel:#fff; --text:#111827; --muted:#4b5563; --accent:#3b82f6; --border:#e5e7eb; }
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Inter',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
.wrap{max-width:1200px;margin:16px auto;padding:0 16px;}
.grid{display:flex;flex-direction:column;gap:16px;}
@media(min-width:768px){.grid{flex-direction:row}.grid>.card{flex:0 0 420px}.grid>.output-column{flex:1;display:flex;flex-direction:column;gap:12px}}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.card>.hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:15px}
.card>.bd{padding:16px}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input[type="number"],input[type="date"],select{width:100%;background:#fff;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px 12px;outline:none;font-size:14px}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.2)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn{background:var(--accent);color:#fff;border:none;padding:5px 10px;border-radius:99px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.btn:hover{background:#2563eb}
.muted{color:var(--muted)}
#map{height:400px;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:14px}
canvas{background:#f0f3f9;border-radius:12px}
</style>
</head>

<body>
<div class="wrap">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
    <div style="font-weight:700">Gulf of Thailand — Tide Map</div>
    <div class="muted">Developed by <b>Rattawit W</b></div>
    <div class="muted" style="margin-left:auto">Time zone: Asia/Bangkok</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd">Pick a point</div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <div style="grid-column:1 / -1">
            <label for="stationSelect">Preset location (optional)</label>
            <select id="stationSelect">
              <option value="">— Select a station from list —</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div><label for="lat">Latitude</label><input id="lat" type="number" step="0.000001" placeholder="9.50"></div>
          <div><label for="lon">Longitude</label><input id="lon" type="number" step="0.000001" placeholder="101.50"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label for="start">Start date (00:00 local)</label><input id="start" type="date"></div>
          <div><label for="end">End date (24:00 local)</label><input id="end" type="date"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Quick range</label>
            <div>
              <button class="btn" data-days="1">1 day</button>
              <button class="btn" data-days="3">3 days</button>
              <button class="btn" data-days="5">5 days</button>
              <button class="btn" data-days="7">7 days</button>
            </div>
          </div>
          <div>
            <label for="interval">Interval</label>
            <select id="interval">
              <option value="10" selected>10 min</option>
              <option value="20">20 min</option>
              <option value="30">30 min</option>
              <option value="60">60 min</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <div id="msgbox" class="muted" style="flex:1">Data served by your Cloudflare Worker API.</div>
          <button id="runBtn" class="btn">Compute tides</button>
          <button id="csvBtn" class="btn">Export CSV</button>
          <button id="pngBtn" class="btn">Export PNG</button>
        </div>
      </div>

      <div class="hd">Map (click to compute)</div>
      <div id="map"></div>
    </div>

    <div class="output-column">
      <div class="card">
        <div class="hd">Tide curve</div>
        <div class="bd"><canvas id="chart" height="170"></canvas></div>
      </div>

      <div class="card">
        <div class="hd">Daily High / Low — Time: HH:mm, Level: m</div>
        <div class="bd" id="hl"></div>
      </div>

      <div class="card">
        <div class="hd">Site constant — z0 (m)</div>
        <div class="bd"><div id="z0">—</div></div>
      </div>
    </div>
  </div>
</div>

<script>
const USE_TZ = 'Asia/Bangkok';
const API = 'https://got-tide.rattawit-aum.workers.dev/api/tides'; // your Worker
const snap = (x, step=0.1) => Math.round(x/step)*step;

function showMsg(t){ const box=document.getElementById('msgbox'); box.textContent=t||''; }
function clearMsg(){ showMsg(''); }

async function fetchTides(lat, lon, start, end, interval=10){
  const u = new URL(API);
  u.searchParams.set('lat', snap(lat));
  u.searchParams.set('lon', snap(lon));
  u.searchParams.set('start', start);
  u.searchParams.set('end', end);
  u.searchParams.set('interval', interval);
  const r = await fetch(u, { mode: 'cors' });
  if (!r.ok) throw new Error(`API error ${r.status}`);
  return r.json(); // { meta, constants:{z0}, series:[[ts,y]...], highs:[], lows:[] }
}

const daySeparator = {
  id:'daySeparator',
  afterDatasetsDraw(chart){
    const {ctx, chartArea, scales} = chart; if(!chartArea||!scales||!scales.x) return;
    const {top,bottom,left,right}=chartArea, x=scales.x, min=x.min, max=x.max;
    if(!Number.isFinite(min)||!Number.isFinite(max)) return;
    let edge = luxon.DateTime.fromMillis(min).setZone(USE_TZ).startOf('day');
    if(edge.toMillis()>min) edge=edge.minus({days:1});
    const edges=[]; for(let t=edge; t.toMillis()<=max+24*3600*1000; t=t.plus({days:1})) edges.push(t.toMillis());
    ctx.save(); ctx.beginPath(); ctx.rect(left,top,right-left,bottom-top); ctx.clip();
    ctx.setLineDash([5,5]); ctx.lineWidth=1.25; ctx.strokeStyle='rgba(148,163,184,0.45)';
    for(const ms of edges.filter(ms=>ms>min&&ms<max)){ const px=x.getPixelForValue(ms); ctx.beginPath(); ctx.moveTo(px,top); ctx.lineTo(px,bottom); ctx.stroke(); }
    ctx.setLineDash([]); ctx.font='12px Inter, system-ui, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='top';
    for(let i=0;i<edges.length-1;i++){ const segL=Math.max(min,edges[i]), segR=Math.min(max,edges[i+1]); if(segR<=segL) continue;
      const cx=x.getPixelForValue((segL+segR)/2), label=luxon.DateTime.fromMillis((segL+segR)/2).setZone(USE_TZ).toFormat('yyyy-LL-dd');
      const w=78,h=16; ctx.fillStyle='rgba(11,18,36,0.75)'; ctx.fillRect(cx-w/2, top+2, w,h); ctx.fillStyle='#e5e7eb'; ctx.fillText(label,cx,top+4); }
    ctx.restore();
  }
};

let chart=null;
function renderChart(series, label){
  const ctx=document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  const data = series.map(([t,y])=>({x:new Date(t), y}));
  chart = new Chart(ctx, {
    type:'line',
    data:{datasets:[{label,data,borderWidth:2,pointRadius:0}]},
    options:{responsive:true,animation:false,interaction:{mode:'index',intersect:false,axis:'x'},scales:{x:{type:'time'},y:{title:{display:true,text:'m'}}}},
    plugins:[daySeparator]
  });
}

function renderHL(highs, lows){
  const div=document.getElementById('hl');
  const fmt = ts => luxon.DateTime.fromMillis(ts).setZone(USE_TZ).toFormat('HH:mm');
  // group by local day
  const byDay = (arr) => {
    const m=new Map();
    for(const [t,y] of arr){ const d=luxon.DateTime.fromMillis(t).setZone(USE_TZ).toFormat('yyyy-LL-dd'); if(!m.has(d)) m.set(d,[]); m.get(d).push([t,y]);}
    return m;
  };
  const hiBy=byDay(highs), loBy=byDay(lows);
  const days=[...new Set([...hiBy.keys(),...loBy.keys()])].sort();
  const rows=[];
  for(const day of days){
    const merged=[...(hiBy.get(day)||[]).map(v=>({t:v[0],y:v[1],type:'High'})),...(loBy.get(day)||[]).map(v=>({t:v[0],y:v[1],type:'Low'}))].sort((a,b)=>a.t-b.t);
    rows.push(`<div style="margin:6px 0 4px;color:#a5b4fc;font-weight:600">${day}</div>`);
    rows.push('<table><thead><tr><th style="text-align:left">Type</th><th style="text-align:center">Time</th><th style="text-align:right">m</th></tr></thead><tbody>');
    merged.forEach(({t,y,type})=>{
      const color = type==='High' ? '#0ea5e9' : '#db2777';
      rows.push(`<tr><td style="color:${color}">${type}</td><td style="text-align:center">${fmt(t)}</td><td style="text-align:right">${y.toFixed(3)}</td></tr>`);
    });
    rows.push('</tbody></table>');
  }
  div.innerHTML = rows.join('') || '<div class="muted">No extrema found in this range.</div>';
}

function renderZ0(constants){
  const z0 = Number(constants?.z0 ?? NaN);
  document.getElementById('z0').textContent = Number.isFinite(z0) ? `${z0.toFixed(6)} m` : '—';
}

async function computeAt(lat, lon, fromManual=false){
  const start = document.getElementById('start').value;
  const end   = document.getElementById('end').value;
  const minutes = +document.getElementById('interval').value;
  if (!start || !end){ showMsg('Choose start & end dates'); return; }

  showMsg('Computing…');
  try{
    const res = await fetchTides(lat, lon, start, end, minutes);
    renderChart(res.series, `${lat.toFixed(4)}, ${lon.toFixed(4)}`);
    renderHL(res.highs, res.lows);
    renderZ0(res.constants);
    clearMsg();

    if(fromManual){
      if(window.clickMarker) map.removeLayer(clickMarker);
      clickMarker = L.marker([lat, lon]).addTo(map).bindPopup(`Lat: ${lat.toFixed(5)}<br>Lon: ${lon.toFixed(5)}`).openPopup();
      map.setView([lat, lon], Math.max(8, map.getZoom()));
    }
  }catch(e){
    showMsg('API unavailable or outside model domain');
  }
}

// CSV/PNG exports (unchanged)
document.getElementById('csvBtn').addEventListener('click', ()=>{
  if(!chart || !chart.data?.datasets?.[0]?.data?.length){ alert('Compute tides first.'); return; }
  const lat = Number.parseFloat(document.getElementById('lat').value);
  const lon = Number.parseFloat(document.getElementById('lon').value);
  const start = document.getElementById('start').value || '';
  const end   = document.getElementById('end').value || '';
  const minutes = Number.parseInt(document.getElementById('interval').value, 10);
  const tz = USE_TZ;

  const header = ['latitude','longitude','timezone','date_local','time_local','tide_m'];
  const rows=[header];
  for (const pt of chart.data.datasets[0].data){
    const d = luxon.DateTime.fromJSDate(pt.x).setZone(tz);
    rows.push([lat.toFixed(6), lon.toFixed(6), tz, d.toFormat('yyyy-LL-dd'), d.toFormat('HH:mm'), Number(pt.y).toFixed(3)]);
  }
  const csv = '\uFEFF' + rows.map(r=>r.join(',')).join('\r\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download=['tide',lat.toFixed(4),lon.toFixed(4),start||'NA',end||'NA',`${minutes}min`,tz.replace('/','-')].join('_')+'.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
});
document.getElementById('pngBtn').addEventListener('click', ()=>{
  const c=document.getElementById('chart'); const url=c.toDataURL('image/png');
  const a=document.createElement('a'); a.href=url; a.download='tide_chart.png';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
});

// Map wiring
const map = L.map('map',{zoomControl:true}).setView([10.5,100.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:12,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let clickMarker=null;
map.on('click', e=>{
  const {lat,lng}=e.latlng;
  document.getElementById('lat').value = lat.toFixed(6);
  document.getElementById('lon').value = lng.toFixed(6);
  computeAt(lat, lng);
});

// Preset dropdown
function populateStationDropdown(){
  try{
    const sel=document.getElementById('stationSelect');
    if(!sel || typeof STATION_COORDS!=='object') return;
    const entries = Object.entries(STATION_COORDS).map(([code,v])=>({code,lat:+v.lat,lon:+v.lon})).sort((a,b)=>a.code.localeCompare(b.code));
    for(const {code,lat,lon} of entries){
      const opt=document.createElement('option'); opt.value=code; opt.textContent=`${code}  (${lat.toFixed(4)}, ${lon.toFixed(4)})`; opt.dataset.lat=lat; opt.dataset.lon=lon; sel.appendChild(opt);
    }
  }catch(_){}
}
function onStationSelected(e){
  const opt=e.target.selectedOptions && e.target.selectedOptions[0]; if(!opt) return;
  const lat=+opt.dataset.lat, lon=+opt.dataset.lon;
  document.getElementById('lat').value=lat.toFixed(6);
  document.getElementById('lon').value=lon.toFixed(6);
  computeAt(lat, lon, true);
}

// Init
(function init(){
  const today = luxon.DateTime.now().setZone(USE_TZ).toFormat('yyyy-LL-dd');
  document.getElementById('start').value=today;
  document.getElementById('end').value=today;
  populateStationDropdown();
  const sel=document.getElementById('stationSelect'); if(sel) sel.addEventListener('change', onStationSelected);
  document.querySelectorAll('button[data-days]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const days=+btn.dataset.days; const sd=document.getElementById('start').value; if(!sd) return;
      const start=new Date(sd+'T00:00:00'); const end=new Date(start.getTime()+(days-1)*24*3600*1000);
      const yyyy=end.getFullYear(), mm=String(end.getMonth()+1).padStart(2,'0'), dd=String(end.getDate()).padStart(2,'0');
      document.getElementById('end').value=`${yyyy}-${mm}-${dd}`;
    });
  });
  document.getElementById('runBtn').addEventListener('click', ()=>{
    const lat=parseFloat(document.getElementById('lat').value);
    const lon=parseFloat(document.getElementById('lon').value);
    if(!Number.isFinite(lat)||!Number.isFinite(lon)){ showMsg('Enter lat/lon or click the map'); return; }
    computeAt(lat, lon, true);
  });
  ['lat','lon','start','end'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ document.getElementById('runBtn').click(); } });
  });
})();
</script>
</body>
</html>
