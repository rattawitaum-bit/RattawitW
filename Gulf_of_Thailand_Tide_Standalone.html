<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gulf of Thailand — Tide (API-only)</title>

<!-- Fonts & minimal CSS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f7fb;--panel:#fff;--txt:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
*{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1100px;margin:18px auto;padding:0 16px}
.hbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.hbar .sp{margin-left:auto;color:var(--muted)}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.card>.hd{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:600}
.card>.bd{padding:14px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
select,.btn{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);font-size:14px}
.btn{background:var(--accent);border:none;color:#fff;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:14px}
.kv div:nth-child(odd){color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
canvas{background:#eef2ff;border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:14px}
th{color:var(--muted);font-weight:600;text-align:left}
#msg{color:var(--muted);min-height:18px}
.pill{display:inline-block;background:#eef2ff;color:#4338ca;border-radius:999px;padding:2px 8px;font-size:12px}
.bad{color:#b91c1c}
</style>

<!-- Chart.js + Luxon time adapter (required for time axis) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="hbar">
    <div style="font-weight:700">Gulf of Thailand — Tide (API)</div>
    <div class="sp">Client computes nothing. Server returns series/highs/lows/z0.</div>
  </div>

  <div class="grid">
    <!-- LEFT: controls & meta -->
    <div class="card">
      <div class="hd">Station</div>
      <div class="bd">
        <label for="station">Choose a station</label>
        <select id="station"></select>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="run" class="btn">Compute</button>
          <button id="csv" class="btn">Export CSV</button>
          <button id="png" class="btn">Export PNG</button>
        </div>
        <div id="msg" style="margin-top:8px"></div>

        <div class="hd" style="margin:12px -14px 6px -14px;padding:10px 14px;border-top:1px solid var(--border);border-bottom:none">Result meta</div>
        <div class="kv bd" id="metaKV">
          <div>Lat, Lon</div><div id="kv-ll">—</div>
          <div>Window</div><div id="kv-win">—</div>
          <div>Interval</div><div id="kv-int">—</div>
          <div>z0</div><div id="kv-z0">—</div>
        </div>
        <div class="small">Window is enforced by the API (Worker). Interval is fixed at 15 min.</div>
      </div>
    </div>

    <!-- RIGHT: chart + highs/lows -->
    <div class="card">
      <div class="hd">Tide curve</div>
      <div class="bd"><canvas id="chart" height="190"></canvas></div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="hd">Daily highs / lows (HH:mm, m)</div>
      <div class="bd" id="hl"></div>
    </div>
  </div>
</div>

<script>
const API = 'https://got-tide.rattawit-aum.workers.dev/api/tides';
const USE_TZ = 'Asia/Bangkok';

// 1) Hard-coded stations (copied from your station_coords.js)
const STATIONS = {
  "AWP26":{"lat":8.5107,"lon":102.2262},
  "AWP36":{"lat":7.94077,"lon":102.6856},
  "B832":{"lat":10.520936,"lon":101.27638},
  "G365":{"lat":7.586336,"lon":102.121412},
  "SBWA":{"lat":8.68628,"lon":101.3838},
  "SGWH":{"lat":8.683,"lon":101.743},
  "PDWA":{"lat":9.47695,"lon":101.394183},
  "PLLQ":{"lat":9.691283333,"lon":101.4042333},
  "BQP":{"lat":8.019097,"lon":102.32179},
  "QPS":{"lat":7.492083333,"lon":102.6147667},
  "FULQ":{"lat":8.933933333,"lon":101.5894333},
  "ERLQ":{"lat":9.077383333,"lon":101.3095},
  "AQP":{"lat":8.260766667,"lon":102.52465},
  "YAWD":{"lat":9.92305,"lon":101.4586},
  "SALQ":{"lat":9.286267,"lon":101.412167}
};

// 2) Populate dropdown
(function initStations(){
  const sel = document.getElementById('station');
  const items = Object.entries(STATIONS)
    .map(([code, v]) => ({ code, lat:+v.lat, lon:+v.lon }))
    .sort((a,b)=> a.code.localeCompare(b.code));
  sel.innerHTML = items.map(({code,lat,lon}) =>
    `<option value="${code}" data-lat="${lat}" data-lon="${lon}">
      ${code} (${lat.toFixed(4)}, ${lon.toFixed(4)})
     </option>`).join('');
})();

// 3) API call
async function fetchTides(lat, lon){
  const u = new URL(API);
  u.searchParams.set('lat', lat);
  u.searchParams.set('lon', lon);
  const r = await fetch(u, { mode:'cors' });
  if (!r.ok) throw new Error(`API ${r.status}`);
  return r.json(); // { meta{lat,lon,start_iso,end_iso,interval_min}, z0, series, highs, lows }
}

// 4) Chart plugin to show daily separators
const daySeparator = {
  id:'daySeparator',
  afterDatasetsDraw(chart){
    const {ctx, chartArea, scales} = chart; if(!chartArea||!scales?.x) return;
    const {top,bottom,left,right} = chartArea, x=scales.x, min=x.min, max=x.max;
    if(!Number.isFinite(min)||!Number.isFinite(max)) return;
    let edge = luxon.DateTime.fromMillis(min).setZone(USE_TZ).startOf('day');
    if(edge.toMillis()>min) edge=edge.minus({days:1});
    const edges=[]; for(let t=edge; t.toMillis()<=max+86400000; t=t.plus({days:1})) edges.push(t.toMillis());
    const mids=edges.filter(ms=>ms>min&&ms<max);
    ctx.save(); ctx.beginPath(); ctx.rect(left,top,right-left,bottom-top); ctx.clip();
    ctx.setLineDash([5,5]); ctx.lineWidth=1.25; ctx.strokeStyle='rgba(148,163,184,0.45)';
    for(const ms of mids){ const px=x.getPixelForValue(ms); ctx.beginPath(); ctx.moveTo(px,top); ctx.lineTo(px,bottom); ctx.stroke(); }
    ctx.setLineDash([]); ctx.restore();
  }
};
let chart=null;
function renderChart(series){
  const ctx=document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  const data = series.map(([t,y])=>({x:new Date(t), y}));
  chart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[{ label:'Tide (m)', data, borderWidth:2, pointRadius:0 }] },
    options:{
      responsive:true, animation:false,
      interaction:{ mode:'index', intersect:false, axis:'x' },
      scales:{ x:{ type:'time', adapters:{date:{zone:USE_TZ}} }, y:{ title:{display:true,text:'m'} } }
    },
    plugins:[daySeparator]
  });
}

// 5) High/low table
function groupByDay(pts){
  const m=new Map(); const k = ms => luxon.DateTime.fromMillis(ms).setZone(USE_TZ).toFormat('yyyy-LL-dd');
  for(const [t,y] of pts){ const kk=k(t); if(!m.has(kk)) m.set(kk,[]); m.get(kk).push([t,y]); }
  return m;
}
function renderHL(highs, lows){
  const div=document.getElementById('hl');
  const fmt = ms => luxon.DateTime.fromMillis(ms).setZone(USE_TZ).toFormat('HH:mm');
  const hiBy=groupByDay(highs), loBy=groupByDay(lows);
  const days=[...new Set([...hiBy.keys(),...loBy.keys()])].sort();
  const out=[];
  for(const d of days){
    const merged=[...(hiBy.get(d)||[]).map(v=>({t:v[0],y:v[1],type:'High'})),
                  ...(loBy.get(d)||[]).map(v=>({t:v[0],y:v[1],type:'Low'}))].sort((a,b)=>a.t-b.t);
    out.push(`<div style="margin:6px 0 4px;color:#6d28d9;font-weight:600">${d}</div>`);
    out.push('<table><thead><tr><th>Type</th><th style="text-align:center">Time</th><th style="text-align:right">m</th></tr></thead><tbody>');
    for(const {t,y,type} of merged){
      const color = type==='High' ? '#0ea5e9' : '#db2777';
      out.push(`<tr><td style="color:${color}">${type}</td><td style="text-align:center">${fmt(t)}</td><td style="text-align:right">${y.toFixed(3)}</td></tr>`);
    }
    out.push('</tbody></table>');
  }
  div.innerHTML = out.join('') || '<div class="small">No extrema in range.</div>';
}

// 6) Meta & z0
function renderMeta(meta, z0){
  document.getElementById('kv-ll').textContent = `${(+meta.lat).toFixed(4)}, ${(+meta.lon).toFixed(4)}`;
  const s = luxon.DateTime.fromISO(meta.start_iso).setZone(USE_TZ).toFormat('yyyy-LL-dd');
  const e = luxon.DateTime.fromISO(meta.end_iso).setZone(USE_TZ).toFormat('yyyy-LL-dd');
  document.getElementById('kv-win').innerHTML = `${s} → ${e} <span class="pill">API-enforced</span>`;
  document.getElementById('kv-int').textContent = `${meta.interval_min} min`;
  document.getElementById('kv-z0').textContent = Number(z0).toFixed(6) + ' m';
}

// 7) CSV / PNG exports
document.getElementById('csv').addEventListener('click', ()=>{
  if(!chart) return alert('Compute first.');
  const rows=[['timestamp_ms','date_local','time_local','tide_m']];
  for(const p of chart.data.datasets[0].data){
    const d = luxon.DateTime.fromJSDate(p.x).setZone(USE_TZ);
    rows.push([p.x.getTime(), d.toFormat('yyyy-LL-dd'), d.toFormat('HH:mm'), Number(p.y).toFixed(3)]);
  }
  const csv = '\uFEFF'+rows.map(r=>r.join(',')).join('\r\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='tide_series.csv'; document.body.appendChild(a); a.click(); a.remove();
});
document.getElementById('png').addEventListener('click', ()=>{
  if(!chart) return alert('Compute first.');
  const a=document.createElement('a'); a.href=document.getElementById('chart').toDataURL('image/png');
  a.download='tide_chart.png'; document.body.appendChild(a); a.click(); a.remove();
});

// 8) Orchestration
async function runSelected(){
  const sel=document.getElementById('station');
  const opt=sel.selectedOptions?.[0]; if(!opt){ return; }
  const lat=+opt.dataset.lat, lon=+opt.dataset.lon;
  try{
    msg('Computing…');
    const res = await fetchTides(lat, lon);
    if(!Array.isArray(res.series) || res.series.length===0){
      msg('No data returned by API.'); return;
    }
    renderChart(res.series);
    renderHL(res.highs || [], res.lows || []);
    renderMeta(res.meta || {}, res.z0);
    msg('');
  }catch(e){ msg('API error. Check CORS or params.'); console.error(e); }
}
function msg(t){ document.getElementById('msg').textContent = t || ''; }

// Bind events & auto-run first station
document.getElementById('run').addEventListener('click', runSelected);
window.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('station').selectedIndex = 0; runSelected(); });
</script>
</body>
</html>
